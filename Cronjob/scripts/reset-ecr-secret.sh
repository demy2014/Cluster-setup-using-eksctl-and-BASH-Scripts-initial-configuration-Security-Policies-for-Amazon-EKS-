#!/bin/bash
set -e

KUBECTL='kubectl'


AWS_DEFAULT_REGION=us-west-1
AWS_ACCOUNT_ID=981666308374

EXISTS=$($KUBECTL get secret "aws-ecr-$AWS_DEFAULT_REGION" --namespace default | tail -n 1 | cut -d ' ' -f 1)
if [ "$EXISTS" = "aws-ecr-$AWS_DEFAULT_REGION" ]; then
  echo "Secret exists, deleting"
  $KUBECTL delete secret "aws-ecr-$AWS_DEFAULT_REGION" --namespace default
fi

PASS=$(aws ecr get-login-password --region $AWS_DEFAULT_REGION)
$KUBECTL create secret docker-registry aws-ecr-$AWS_DEFAULT_REGION \
    --docker-server=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com \
    --docker-username=AWS \
    --docker-password=eyJwYXlsb2FkIjoiZEtmU1V1TnZNckJoRWNtajlqN3doYVhhM043TFpJT2NESVBEeE43SGpyV0lZczA5V0xlLzdycW9NTkVucWg1WHY5eUhzd0x0T1NlMFc1L0Zhd1daOUNHRmkxUklwQlZKQUpja09kcitqUHArNm00aUFYT3cxSmZZVEUzTWdCOXdNa24vTVNYbWgzUUFWNlNXeDRaRTNGWmdrYXhVRE5BQjI0WUhDeDlWTWFZRUFiMnZ6bDcwUHdNaFFkWFJCbERGa1dCbXNNVkd0c2xaMkJ2QzdpWU0rdWFLc3hwdytVb3BiMG04WDUzelNrOVlVcmpTYyt0eGFwUUc4ZTNuYUgwczJqZmRMcnlhaHdzSFRMMkNZdnJ6SzQ4YWliTTEvWWQySkp3Wm9SNzF1Y0E4Zm02eGRUKzlETzhDcU1IQjE5SUJ0KzRpTGluU29nUXBvbTN6QnQzZGJvWVNOU2ZVK3dnN0lIVk9hU0dMR2ZJekN4VnBwWGtPWUpvdjlrNEdpWFRYWk43elIySnAxNEZKVGd3SnNWcW1qbU01MXE1MDhpdVZyMVZzNG8xWWtyOWFMb1pvK0NCSkRKV2tvNENUSE9aZlpKZHB1N3RlSTVTUWF3cWoxTk9oSU0veFVHclRCelJuTDB0cWlZNFA5UGlWL1oxQzN6ckU4WmlmWFNzbEtzaXpMT1lhS1BwNWxydFZ2eFExNERidnd4c1ErWjdwWml0dVp3ck9qWmVpa0NpV1JmWjE4ZjdHQjE3VFR5THhUSVcwVkVyL1drNGFlWXIxdVNjdWFKZ3IwV2ZVcUYzYitYVDZOMmpDZ0tVdWpyelk5OXNjdmZxL254MFJwNlJDL1oxenpQMVllY0d6RjRMN3VCRHpleUpwZUpzSERPM0ZOTjFZUTV2RzdlL25Va2NvMWdvaFNmMndXNk54MWZrSUhUdUVabjNsUzJiNjVmRlMvc0xMSXVwWmpZT3hhMFhoOEZ3cmNVQ3IzR0JQeGZ5MmdhTzhFM3UrSk9waVZlYTNmdFUwbTFtNFpBeUpCLzZrc0lIQUVPbXpWdzB6Vi85ZExncFA3NGVUbm5UOUVwVjd0czRrZTE2cjRmNUpBZU1jc0JhVkhVSEJGZktWY0lxZkpQcmg1SlJXSDNIK0NybVkvaGVjU1VZNW9zT0xnU3lqaTJQZXd1ejdHaTdMQ2RZVEZrNmFFdnVoVVlMMkxaeVVkRHlDUWNET1llemo4VnJZWG03N3VCTkMvdENldHdGOFh0MWd2SG1LZ1RIRzFVWWx4aG8zeU1pWC9RMU0yUGNZNk42V05PdVRFejlLUFYwek0xZE5ZbHpvZkwxeFloV2ZjNjNXMk8vWFMwU2tzZ2VaIiwiZGF0YWtleSI6IkFRRUJBSGlqRUZYR3dGMWNpcFZPYWNHOHFSbUpvVkJQYXk4TFVVdlU4UkNWVjBYb0h3QUFBSDR3ZkFZSktvWklodmNOQVFjR29HOHdiUUlCQURCb0Jna3Foa2lHOXcwQkJ3RXdIZ1lKWUlaSUFXVURCQUV1TUJFRURBd2Q5cEI2MG9pQW1jYjI2Z0lCRUlBN1ZSRTVORHcvMGd6SC9QVjJ3Q2xObmx4KzQwZHNNLzRKclpoS2FhZ0JnL2FrcG00bjQ3dVdPZTAwVDNiTUpDOTBwUloxNVB4WUd5SXlCbTQ9IiwidmVyc2lvbiI6IjIiLCJ0eXBlIjoiREFUQV9LRVkiLCJleHBpcmF0aW9uIjoxNzIxMzEzODE5fQ== \
    --docker-email=demy@castingapp.com --namespace default
